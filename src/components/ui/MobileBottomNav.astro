---
const currentPath = Astro.url.pathname
const isHomePage = currentPath === '/'
const isCollectionsPage = currentPath.startsWith('/collections')
const isTagsPage = currentPath.startsWith('/tags')
const isArchivePage = currentPath.startsWith('/archive')
---

<nav class="mobile-bottom-nav" id="mobile-bottom-nav">
  <div class="nav-container">
    <a href="/" class={`nav-item ${isHomePage ? 'active' : ''}`} aria-label="Home">
      <svg
        class="nav-icon"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
      <span class="nav-label">Home</span>
    </a>

    <a
      href="/collections/"
      class={`nav-item ${isCollectionsPage ? 'active' : ''}`}
      aria-label="Collections"
    >
      <svg
        class="nav-icon"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
      </svg>
      <span class="nav-label">Collections</span>
    </a>

    <a href="/tags/" class={`nav-item ${isTagsPage ? 'active' : ''}`} aria-label="Tags">
      <svg
        class="nav-icon"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"
        ></path>
        <line x1="7" y1="7" x2="7.01" y2="7"></line>
      </svg>
      <span class="nav-label">Tags</span>
    </a>

    <a href="/archive/" class={`nav-item ${isArchivePage ? 'active' : ''}`} aria-label="Archive">
      <svg
        class="nav-icon"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      <span class="nav-label">Archive</span>
    </a>
  </div>
</nav>

<script>
  function initMobileBottomNav() {
    const nav = document.getElementById('mobile-bottom-nav')
    if (!nav) return

    // Auto-hide on scroll down, show on scroll up
    let lastScrollY = window.scrollY
    let ticking = false

    function updateNavVisibility() {
      if (!nav) return

      const currentScrollY = window.scrollY

      if (currentScrollY > lastScrollY && currentScrollY > 150) {
        // Scrolling down - hide
        nav.classList.add('hidden')
      } else {
        // Scrolling up - show
        nav.classList.remove('hidden')
      }

      lastScrollY = currentScrollY
      ticking = false
    }

    function onScroll() {
      if (!ticking) {
        window.requestAnimationFrame(updateNavVisibility)
        ticking = true
      }
    }

    window.addEventListener('scroll', onScroll, { passive: true })

    // Haptic feedback on tap
    const navItems = nav.querySelectorAll('.nav-item')
    navItems.forEach((item) => {
      item.addEventListener('click', () => {
        if ('vibrate' in navigator) {
          navigator.vibrate(10)
        }
      })
    })
  }

  // Initialize on page load
  document.addEventListener('astro:page-load', initMobileBottomNav)
  document.addEventListener('DOMContentLoaded', initMobileBottomNav)
</script>

<style>
  .mobile-bottom-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 999;
    padding: 0 1rem calc(1.25rem + env(safe-area-inset-bottom));
    pointer-events: none;
    transition:
      transform 0.35s cubic-bezier(0.4, 0, 0.2, 1),
      opacity 0.35s ease;
  }

  .mobile-bottom-nav.hidden {
    transform: translateY(calc(100% + 2rem));
    opacity: 0;
  }

  @media (max-width: 768px) {
    .mobile-bottom-nav {
      display: block;
    }
  }

  .nav-container {
    display: flex;
    justify-content: space-evenly;
    align-items: center;
    gap: 0;
    padding: 0.375rem 0.5rem;
    background: rgba(var(--bg-primary-rgb), 0.75);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 0.5px solid var(--border);
    border-radius: 20px;
    box-shadow:
      0 8px 16px -4px rgba(0, 0, 0, 0.08),
      0 4px 8px -2px rgba(0, 0, 0, 0.04),
      inset 0 1px 0 0 rgba(255, 255, 255, 0.05);
    pointer-events: auto;
    max-width: 280px;
    margin: 0 auto;
    will-change: transform;
  }

  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    padding: 0.5rem 0.625rem;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 14px;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    flex: 1;
    min-width: 0;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    -webkit-user-select: none;
  }

  .nav-item:active {
    transform: scale(0.88);
  }

  /* Hover state for devices that support it */
  @media (hover: hover) and (pointer: fine) {
    .nav-item:hover:not(.active) {
      color: var(--text-primary);
    }

    .nav-item:hover:not(.active) .nav-icon {
      opacity: 0.85;
    }

    .nav-item:hover:not(.active) .nav-label {
      opacity: 0.8;
    }
  }

  .nav-item.active {
    color: var(--text-primary);
  }

  .nav-item.active .nav-icon {
    opacity: 1;
  }

  .nav-item.active .nav-label {
    opacity: 1;
    font-weight: 600;
  }

  /* Active indicator - subtle dot */
  .nav-item.active::before {
    content: '';
    position: absolute;
    top: 0.25rem;
    left: 50%;
    transform: translateX(-50%);
    width: 3px;
    height: 3px;
    background: var(--text-primary);
    border-radius: 50%;
    opacity: 0.7;
  }

  .nav-icon {
    width: 21px;
    height: 21px;
    stroke-width: 1.75;
    opacity: 0.7;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .nav-item:active .nav-icon {
    transform: scale(0.85);
  }

  .nav-label {
    font-size: 0.6rem;
    font-family: var(--sans);
    letter-spacing: 0.01em;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0.65;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Very small screens - icon only */
  @media (max-width: 360px) {
    .nav-label {
      display: none;
    }

    .nav-item {
      padding: 0.625rem 0.5rem;
    }

    .nav-item.active::before {
      top: 0.375rem;
    }

    .nav-icon {
      width: 22px;
      height: 22px;
    }

    .nav-container {
      padding: 0.5rem 0.375rem;
      max-width: 240px;
    }
  }

  /* Dark mode enhancements */
  html.dark .nav-container {
    background: rgba(var(--bg-primary-rgb), 0.8);
    box-shadow:
      0 8px 16px -4px rgba(0, 0, 0, 0.4),
      0 4px 8px -2px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 0 rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.08);
  }

  /* Smooth appearance animation */
  @keyframes slideUp {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .mobile-bottom-nav {
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.1s both;
  }

  /* Prevent layout shift */
  @media (max-width: 768px) {
    body {
      padding-bottom: env(safe-area-inset-bottom);
    }
  }

  /* Accessibility - focus states */
  .nav-item:focus-visible {
    outline: 2px solid var(--text-primary);
    outline-offset: 2px;
  }

  /* Reduce motion for users who prefer it */
  @media (prefers-reduced-motion: reduce) {
    .mobile-bottom-nav,
    .nav-item,
    .nav-icon,
    .nav-label {
      animation: none;
      transition: none;
    }

    .mobile-bottom-nav.hidden {
      display: none;
    }
  }
</style>
