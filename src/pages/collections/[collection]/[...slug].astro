---
import { type CollectionEntry, getCollection } from 'astro:content'
import PostLayout from '@/layouts/PostLayout.astro'
import { render } from 'astro:content'
import { getCollectionKeys, getContentConfig, type CollectionKey } from '@/collections.config'

export async function getStaticPaths() {
  const collectionKeys = getCollectionKeys()

  const paths = await Promise.all(
    collectionKeys.map(async (collectionName) => {
      const posts = await getCollection(collectionName)
      return posts
        .filter((post: any) => !post.id.startsWith('_'))
        .map((post: any) => ({
          params: {
            collection: collectionName,
            slug: post.id
          },
          props: { post, collection: collectionName }
        }))
    })
  )

  return paths.flat()
}

type Props = {
  post:
    | CollectionEntry<'gallery'>
    | CollectionEntry<'thoughts'>
    | CollectionEntry<'projects'>
    | CollectionEntry<'media'>
    | CollectionEntry<'blog'>
  collection: CollectionKey
}

const { post, collection } = Astro.props
const { Content, remarkPluginFrontmatter } = await render(post)

const readingTime = remarkPluginFrontmatter.readingTime
const toc = remarkPluginFrontmatter.toc || []

// Get config for this collection
const collectionConfig = getContentConfig(collection)
const backUrl = collectionConfig.listPage
const backLabel = collectionConfig.backLabel
---

<PostLayout
  {...post.data}
  readingTime={readingTime}
  toc={toc}
  backUrl={backUrl}
  backLabel={backLabel}
>
  <Content />
</PostLayout>
